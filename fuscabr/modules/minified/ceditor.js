/******************************************
 * FBR - "Funções úteis para o ScadaBR"
 * License: MIT
 ******************************************/
"use strict";fuscabr.ceditor={createdEditors:[],watchdog:null,fileCounter:[0,0],loadDependency:function(e,t,r){var i;"script"==t?(i=document.createElement("script")).src=e:"style"==t&&((i=document.createElement("link")).rel="stylesheet",i.href=e),r&&i.addEventListener("load",r),document.getElementById("fuscabr-modules").appendChild(i)},loadCodeMirror:function(){var e=this.conf;this.loadDependency(e.baseFolder+"codemirror.css","style"),"codemirror.css"!=e.theme&&"default"!=e.theme&&this.loadDependency(e.themesFolder+e.theme,"style"),this.loadDependency(e.baseFolder+"codemirror.min.js","script",fuscabr.ceditor.start)},loadLanguage:function(e,t,r){var i=this.conf.modesFolder,c=this.conf.addonsFolder,a=[];if("html"==e?(a.push(c+"fold/xml-fold.js"),a.push(c+"edit/closebrackets.js"),a.push(c+"edit/closetag.js"),a.push(c+"edit/matchbrackets.js"),a.push(i+"xml/xml.js"),a.push(i+"javascript/javascript.js"),a.push(i+"css/css.js"),a.push(i+"htmlmixed/htmlmixed.js")):"javascript"==e||"json"==e?(a.push(c+"edit/closebrackets.js"),a.push(c+"edit/matchbrackets.js"),a.push(i+"javascript/javascript.js")):"sql"==e&&(a.push(c+"edit/closebrackets.js"),a.push(c+"edit/matchbrackets.js"),a.push(i+"sql/sql.js")),r){for(var o=[],s=0;s<a.length;s++)document.querySelector("#fuscabr-modules script[src*='"+a[s]+"']")||o.push(a[s]);o.length&&(a=o)}var n=[];for(var s of a)n.push(fuscabr.ceditor.load(s,"javascript",!0));Promise.all(n).then(function(){setTimeout(t,200)}).catch(function(){fuscabr.ceditor.loadLanguage(e,t,!0)})},loadLanguageCb:function(e,t,r){fuscabr.ceditor.fileCounter[t]++,e==fuscabr.ceditor.fileCounter[t]&&(fuscabr.ceditor.fileCounter[t]=0,r())},load:function(e,t,r){return new Promise(function(i,c){let a,o=e.includes("?")?e+"&ts="+Date.now():e+"?ts="+Date.now();r&&(e=o),"javascript"==t?((a=document.createElement("script")).src=e,a.async=!0):"css"==t&&((a=document.createElement("link")).rel="stylesheet",a.href=e),a.addEventListener("error",function(e){c(e,a)}),a.addEventListener("load",i),document.getElementById("fuscabr-modules").appendChild(a)})},updateEditors:function(){for(var e of fuscabr.ceditor.createdEditors)e.setValue(e.getTextArea().value)},updateTextAreas:function(){for(var e of fuscabr.ceditor.createdEditors)e.save()},generalWatchdog:function(e){var t=document.querySelector(e);this.watchdog=t.value,setInterval(function(){fuscabr.ceditor.watchdog!=document.querySelector(e).value&&(fuscabr.ceditor.watchdog=document.querySelector(e).value,fuscabr.ceditor.updateEditors())},this.conf.watchdogInterval)},emportWatchdog:function(e){var t=document.querySelector(e),r=function(){t.disabled||(fuscabr.ceditor.updateEditors(),clearInterval(fuscabr.ceditor.watchdog))};this.watchdog=setInterval(r,this.conf.watchdogInterval)},viewEditWatchdog:function(e){var t=document.querySelector(e),r=function(){"none"!=t.style.display&&(fuscabr.ceditor.updateEditors(),clearInterval(fuscabr.ceditor.watchdog))};this.watchdog=setInterval(r,this.conf.watchdogInterval)},createEditor:function(e,t,r){var i=document.querySelector(e),c={lineNumbers:!0,indentUnit:4};"default"!=this.conf.theme&&"codemirror.css"!=this.conf.theme&&(c.theme=this.conf.theme.replace(".css","")),c.autoCloseBrackets=!0,c.matchBrackets=!0,"html"==t||"htmlmixed"==t?(c.mode="htmlmixed",c.autoCloseTags=!0):"javascript"==t||"json"==t?(c.mode={name:"javascript"},c.mode.json="json"==t):"sql"==t&&(c.mode="sql");var a=CodeMirror.fromTextArea(i,c),o=this.conf.editorSize;o[r]?a.setSize(o[r].width,o[r].height):a.setSize(o.default.width,o.default.height),a.refresh(),this.createdEditors.push(a)},createListener:function(e,t,r,i){var c=document.querySelector(e);i&&(c=c.parentElement),c&&c.addEventListener(t,r,!0)},createCustomCSS:function(){var e=document.createElement("style");e.innerHTML=".CodeMirror { border: 1px solid "+this.conf.editorBorderColor+";",e.innerHTML+="font-size: "+this.conf.editorFontSize+"}",e.innerHTML+=".CodeMirror-scroll, .CodeMirror-sizer, .CodeMirror-gutter, .CodeMirror-gutters, .CodeMirror-linenumber { box-sizing: content-box !important; }",document.getElementById("fuscabr-modules").appendChild(e)},start:function(){var e=window.location.href,t=fuscabr.ceditor;t.createCustomCSS(),e.includes("sql.shtm")?t.loadLanguage("sql",function(){t.createEditor("#sqlString","sql","sql.shtm")}):e.includes("emport.shtm")?(t.loadLanguage("json",function(){t.createEditor("#emportData","json","emport.shtm")}),t.createListener("#exportJsonBtn","click",function(){t.emportWatchdog("#exportJsonBtn")}),t.createListener("#importJsonBtn","click",t.updateTextAreas)):e.includes("point_links.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","point_links.shtm")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='savePointLink()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='validateScript()']","click",t.updateTextAreas,!0)):e.includes("compound_events.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#condition","javascript","compound_events.shtm")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='saveCompoundEvent()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='validate()']","click",t.updateTextAreas,!0),insertText=function(e){t.createdEditors[0].replaceSelection(e)}):e.includes("scripting.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","scripting.shtm")}),t.generalWatchdog("#xid"),t.createListener("#executeScriptImg","click",t.updateTextAreas,!0),t.createListener("img[onclick*='saveScript()']","click",t.updateTextAreas,!0)):e.includes("view_edit.shtm")?(t.loadLanguage("javascript",function(){t.createEditor("#graphicRendererScriptScript","javascript","view_edit.shtm")}),t.loadLanguage("html",function(){t.createEditor("#staticPointContent","html","view_edit.shtm")}),t.createListener("#graphicRendererScriptScript","change",t.updateEditors),t.createListener("#staticPointContent","change",t.updateEditors),t.createListener("#graphicRendererEditorPopup .fuscabr-csnippet-apply","click",t.updateEditors),t.createListener("#htmlEditor .fuscabr-csnippet-apply","click",t.updateEditors),t.createListener("img[onclick*='staticEditor.save()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='graphicRendererEditor.save()']","click",t.updateTextAreas,!0),openStaticEditor=function(e){closeEditors(),fuscabr.ceditor.viewEditWatchdog("#staticEditorPopup"),staticEditor.open(e)},openGraphicRendererEditor=function(e){closeEditors(),fuscabr.ceditor.viewEditWatchdog("#graphicRendererEditorPopup"),graphicRendererEditor.open(e)},fuscabr.csnippet&&fuscabr.csnippet.callbackFunctions.push(fuscabr.ceditor.updateEditors)):e.includes("data_source_edit.shtm")&&(document.getElementById("webcamLiveFeedCode")?(t.loadLanguage("html",function(){t.createEditor("#webcamLiveFeedCode","html","httpimage_ds")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)):document.getElementById("script")?(t.loadLanguage("javascript",function(){t.createEditor("#script","javascript","meta_ds")}),t.generalWatchdog("#xid"),t.createListener("img[onclick*='validateScript()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)):document.getElementById("selectStatement")&&(t.loadLanguage("sql",function(){t.createEditor("#selectStatement","sql","sql_ds_1")}),t.loadLanguage("sql",function(){t.createEditor("textarea[name='updateStatement']","sql","sql_ds_2")}),t.generalWatchdog("#xid"),t.createListener("#sqlTestBtn","click",t.updateTextAreas,!0),t.createListener("img[onclick*='saveDataSource()']","click",t.updateTextAreas,!0),t.createListener("img[onclick*='savePoint()']","click",t.updateTextAreas,!0)))},getSettings:function(){ajaxGetJson("resources/fuscabr/conf/modules/ceditor.json",function(e){fuscabr.ceditor.conf=e,fuscabr.ceditor.init()})},init:function(){fuscabr.ceditor.conf?fuscabr.ceditor.loadCodeMirror():fuscabr.ceditor.getSettings()}},fuscabr.ceditor.init();

/******************************************
 * FBR - "Funções úteis para o ScadaBR"
 * License: MIT
 ******************************************/
"use strict";fuscabr.chart={createdCharts:[],loop:function(){var t=document.querySelectorAll("div:not(.fuscabr-chart-container) > div > input.fuscabr-chart-data");e=t.length;for(var a=0;a<e;a++)fuscabr.chart.createNewCharts(t[a]);for(var e=fuscabr.chart.createdCharts.length,a=0;a<e;a++)-1==fuscabr.chart.updateCharts(fuscabr.chart.createdCharts[a])&&fuscabr.chart.createdCharts.splice(a,1)},createNewCharts:function(t){if("undefined"==typeof Chart){this.loadChartJs();return}var a=this.formatData(t.value),e=t.parentElement.parentElement,r=a[0],n=document.createElement("canvas"),o=document.createElement("div");r.chartBackgroundColor=r.chartBackgroundColor||"rgba(255,255,255,0.0)";var s=this.conf.timeOptions;n.classList.add("fuscabr-chart-canvas"),o.style=`height: ${r.height}px; width: ${r.width}px; background-color: ${r.chartBackgroundColor};`,o.style.position="relative",o.appendChild(n),e.appendChild(o),e.classList.add("fuscabr-chart-container");var i=n.getContext("2d"),c=new Chart(i,{type:r.type,data:r.data});for(var d in c.options.elements.line.tension=0,c.options.maintainAspectRatio=!1,r.customOptions)c.options[d]=r.customOptions[d];!0==r.beginAtZero&&(c.options.scales.yAxes[0].ticks.beginAtZero=!0),!1==r.animations&&(c.options.animation.duration=0),!0==r.timeBased?(c.options.scales.xAxes[0].type="time",c.options.scales.xAxes[0].time=s):(c.options.scales.xAxes[0].ticks.display=!1,c.options.scales.xAxes[0].gridLines.drawTicks=!1),!0==r.showTitle&&(c.options.title.display=!0,c.options.title.text=r.title),this.conf.enableDatapointWarnings&&this.invalidDatapointWarning(e,a[1]),c.update(),fuscabr.chart.createdCharts.push(c)},updateCharts:function(t){var a,e=t.canvas.parentElement.parentElement,r=[],n={};try{(n=(r=this.formatData(e.querySelector(".fuscabr-chart-data").value))[0]).chartBackgroundColor=n.chartBackgroundColor||"rgba(255,255,255,0.0)"}catch{return fuscabr.chart.destroyChart(t),-1}if(t.config.type!=n.type)return fuscabr.chart.destroyChart(t),-1;if(t.options.scales.xAxes[0]){if("time"==t.options.scales.xAxes[0].type!=n.timeBased)return fuscabr.chart.destroyChart(t),-1}if(t.data.datasets.length!=n.data.datasets.length)return fuscabr.chart.destroyChart(t),-1;for(var o in t.canvas.parentElement.style.height=n.height+"px",t.canvas.parentElement.style.width=n.width+"px",t.canvas.parentElement.style.backgroundColor=n.chartBackgroundColor.replaceAll(";",""),n.customOptions)t.options[o]=n.customOptions[o];var s=!1,i=t.options.scales.yAxes[0].ticks.beginAtZero;i!=n.beginAtZero&&(t.options.scales.yAxes[0].ticks.beginAtZero=n.beginAtZero,s=!0),(i=t.options.animation.duration>0)!=n.animations&&(t.options.animation.duration=!0==n.animations?1e3:0,s=!0),((i=t.options.title).display!=n.showTitle||i.text!=n.title)&&(t.options.title.display=n.showTitle,t.options.title.text=n.title,s=!0);for(var c=n.data.datasets.length,d=0;d<c;d++){var l=t.data.datasets[d].data,h=n.data.datasets[d].data;JSON.stringify(l)!=JSON.stringify(h)&&(t.data.datasets[d].data=h,s=!0),(l=t.data.datasets[d].label)!=(h=n.data.datasets[d].label)&&(t.data.datasets[d].label=h,s=!0),(l=t.data.datasets[d].backgroundColor)!=(h=n.data.datasets[d].backgroundColor)&&(t.data.datasets[d].backgroundColor=h,s=!0),(l=t.data.datasets[d].borderColor)!=(h=n.data.datasets[d].borderColor)&&(t.data.datasets[d].borderColor=h,s=!0)}this.conf.enableDatapointWarnings&&this.invalidDatapointWarning(e,r[1]),!0==s&&t.update()},destroyChart:function(t){var a=t.canvas.parentElement;a.parentElement.classList.remove("fuscabr-chart-container"),t.destroy(),a.remove()},invalidDatapointWarning:function(t,a){if(t.querySelector(".fuscabr-chart-warning"))t.querySelector(".fuscabr-chart-warning").innerHTML=a;else{var e=document.createElement("span");e.className="fuscabr-chart-warning",e.innerHTML=a,t.appendChild(e)}},formatData:function(t){var a=JSON.parse(t),e=[{},""];for(var r in e[0]=a,e[0].data.datasets){var n=e[0].data.datasets[r];if("undefined"==n.backgroundColor&&(e[0].data.datasets[r].backgroundColor=this.conf.fallbackBackgroundColor),"undefined"==n.borderColor&&(e[0].data.datasets[r].borderColor=this.conf.fallbackBorderColor),0!=n.data.length){if(e[0].timeBased){var o=String(n.data[0].y);if(!1==isNaN(parseFloat(o)))continue;if("false"==o||"true"==o){for(var r of e[0].data.datasets[r].data)"true"==String(r.y)?r.y=1:r.y=0;continue}e[0].data.datasets.splice(r,1),this.conf.enableDatapointWarnings&&(e[1]+="&quot;"+n.label+"&quot; is not a numeric or binary datapoint <br>")}else{var o=String(n.data[0]);if(!1==isNaN(parseFloat(o)))continue;if("false"==o||"true"==o){for(var r of e[0].data.datasets[r].data)r="true"==String(r)?1:0;continue}e[0].data.datasets.splice(r,1),this.conf.enableDatapointWarnings&&(e[1]+="&quot;"+n.label+"&quot; is not a numeric or binary datapoint <br>")}}}return e},loadChartJs:function(){if(!document.getElementById("fuscabr-chartjs")){var t=document.createElement("script");t.src=this.conf.chartJsFile,t.id="fuscabr-chartjs",t.onload=fuscabr.chart.loop,document.getElementById("fuscabr-modules").appendChild(t)}},getSettings:function(){ajaxGetJson("resources/fuscabr/conf/modules/chart.json",function(t){fuscabr.chart.conf=t,fuscabr.chart.init()})},init:function(){fuscabr.chart.conf?(fuscabr.chart.loop(),setInterval(function(){fuscabr.chart.loop.call(fuscabr.chart)},fuscabr.chart.conf.refreshTime)):fuscabr.chart.getSettings()}},fuscabr.chart.init();
